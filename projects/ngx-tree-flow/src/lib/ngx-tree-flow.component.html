<div
  style="width: 100%; display: flex"
  [class.fit]="fitParent"
  [style.justify-content]="
    horizontalAlign === 'center' ? 'center' : horizontalAlign === 'start' ? 'flex-start' : 'flex-end'
  "
>
  <div
    [ngStyle]="{
      'max-width': maxWidth ?? 'auto',
      'min-width': minWidth ?? 'auto'
    }"
  >
    <svg
      preserveAspectRatio="xMidYMid meet"
      [attr.transform]="'rotate(-' + rotation + ')'"
      style="width: 100%"
      [class.fit]="fitParent"
      [attr.viewBox]="viewBox"
      xmlns="http://www.w3.org/2000/svg"
      version="1.1"
    >
      <?xml -stylesheet=-stylesheet type="text/css" href="ngx-tree-flow.component.scss" ?>

      <!-- <rect width="100%" height="100%" style="stroke: red; stroke-width: 5" /> -->
      <g [attr.transform]="isLinear && !hideLinearModelLabel ? 'translate(-' + (viewboxWidth * 1) / 4 + ',0)' : ''">
        <!-- connection lines -->
        <g *ngFor="let row of design; let rowIndex = index" [attr.transform]="verticalAlignTranslate">
          <g *ngFor="let node of row; let nodeIndex = index">
            <!-- if is a join node we need to link all upper nodes -->
            <g *ngIf="node.isJoinNode">
              <g *ngFor="let _ of design[rowIndex - 1]; let prev = index">
                <line
                  *ngIf="rowIndex != 0"
                  [class.line-color-default]="disableAutoLineColor"
                  [class]="{
                    'line-default': node.state === states.default,
                    'line-disabled': node.state === states.disabled || node.state === states.error,
                    'line-enabled': node.state === states.enabled,
                    'line-active': node.state === states.active,
                    'line-completed': node.state === states.completed
                  }"
                  [attr.x1]="design[rowIndex - 1][prev].dx + nodeRadius"
                  [attr.y1]="design[rowIndex - 1][prev].dy + nodeRadius"
                  [attr.x2]="node.dx + nodeRadius"
                  [attr.y2]="node.dy + nodeRadius"
                  [attr.stroke-width]="lineStrokeWidth"
                />
              </g>
            </g>
            <g *ngIf="!node.isJoinNode">
              <g *ngFor="let _ of design[rowIndex - 1]; let prev = index">
                <line
                  *ngIf="rowIndex != 0"
                  [class.line-color-default]="disableAutoLineColor"
                  [class]="{
                    'line-default': node.state === states.default,
                    'line-disabled': node.state === states.disabled,
                    'line-enabled': node.state === states.enabled,
                    'line-active': node.state === states.active,
                    'line-completed': node.state === states.completed,
                    'line-error': node.state === states.error
                  }"
                  [attr.x1]="design[rowIndex - 1][0].dx + nodeRadius"
                  [attr.y1]="design[rowIndex - 1][0].dy + nodeRadius"
                  [attr.x2]="node.dx + nodeRadius"
                  [attr.y2]="node.dy + nodeRadius"
                  [attr.stroke-width]="lineStrokeWidth"
                />
              </g>
            </g>
          </g>
        </g>
        <!-- nodes -->
        <g *ngFor="let row of design; let rowIndex = index" [attr.transform]="verticalAlignTranslate">
          <g *ngFor="let node of row; let nodeIndex = index">
            <g>
              <g *ngIf="node.isJoinNode">
                <svg
                  [attr.width]="nodeJoinRadius * 2"
                  [attr.height]="nodeJoinRadius * 2"
                  [attr.viewBox]="viewBoxJoinNode"
                  [attr.x]="node.dx + nodeRadius - nodeJoinRadius"
                  [attr.y]="node.dy + nodeRadius - nodeJoinRadius"
                  [class.node-default]="node.state === states.default"
                  [class.node-disabled]="node.state === states.disabled"
                  [class.node-enabled]="node.state === states.enabled"
                  [class.node-active]="node.state === states.active"
                  [class.node-completed]="node.state === states.completed"
                  [class.node-error]="node.state === states.error"
                >
                  <circle cx="50%" cy="50%" [attr.r]="nodeJoinRadius" [attr.stroke-width]="nodeJoinStrokeWidth" />
                </svg>
              </g>
              <g *ngIf="!node.isJoinNode">
                <svg
                  [attr.width]="nodeRadius * 2"
                  [attr.height]="nodeRadius * 2"
                  [attr.viewBox]="viewBoxNode"
                  [attr.x]="node.dx"
                  [attr.y]="node.dy"
                  [class.node-default]="node.state === states.default"
                  [class.node-disabled]="node.state === states.disabled"
                  [class.node-enabled]="node.state === states.enabled"
                  [class.node-active]="node.state === states.active"
                  [class.node-completed]="node.state === states.completed"
                  [class.node-error]="node.state === states.error"
                >
                  <circle cx="50%" cy="50%" [attr.r]="nodeRadius" [attr.stroke-width]="nodeStrokeWidth" />
                  <text
                    *ngIf="useLabels"
                    transform-origin="center"
                    [attr.transform]="'rotate(' + rotation + ')'"
                    dominant-baseline="central "
                    text-anchor="middle"
                  >
                    <tspan y="50%" x="50%">{{ node.label ?? '' }}</tspan>
                  </text>
                  <text
                    *ngIf="!useLabels"
                    transform-origin="center"
                    [attr.transform]="'rotate(' + rotation + ')'"
                    dominant-baseline="middle"
                    text-anchor="middle"
                  >
                    <tspan y="50%" x="50%">{{ node.id }}</tspan>
                  </text>
                </svg>
                <svg
                  *ngIf="isLinear && !hideLinearModelLabel"
                  [attr.height]="nodeRadius * 2"
                  [attr.width]="viewboxWidth / 2"
                  [attr.x]="node.dx + nodeRadius * 2"
                  [attr.y]="node.dy"
                  [class.node-default]="node.state === states.default"
                  [class.node-disabled]="node.state === states.disabled"
                  [class.node-enabled]="node.state === states.enabled"
                  [class.node-active]="node.state === states.active"
                  [class.node-completed]="node.state === states.completed"
                  [class.node-error]="node.state === states.error"
                >
                  <text
                    transform-origin="center"
                    [attr.transform]="'rotate(' + rotation + ')'"
                    dominant-baseline="central "
                    text-anchor="start"
                  >
                    <tspan class="linearLabel" y="50%" x="10%">
                      {{ node.label ?? '' }}
                    </tspan>
                  </text>
                </svg>
              </g>
            </g>
          </g>
        </g>
      </g>
    </svg>
  </div>
</div>
